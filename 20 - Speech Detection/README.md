# 20 Speech Detection ä¸­æ–‡æŒ‡å—

> ä½œè€…ï¼š61hhh 
> ç®€ä»‹ï¼š[JavaScript30](https://javascript30.com) æ˜¯ [Wes Bos](https://github.com/wesbos) æ¨å‡ºçš„ä¸€ä¸ª 30 å¤©æŒ‘æˆ˜ã€‚é¡¹ç›®å…è´¹æä¾›äº† 30 ä¸ªè§†é¢‘æ•™ç¨‹ã€30 ä¸ªæŒ‘æˆ˜çš„èµ·å§‹æ–‡æ¡£å’Œ 30 ä¸ªæŒ‘æˆ˜è§£å†³æ–¹æ¡ˆæºä»£ç ã€‚ç›®çš„æ˜¯å¸®åŠ©äººä»¬ç”¨çº¯ JavaScript æ¥å†™ä¸œè¥¿ï¼Œä¸å€ŸåŠ©æ¡†æ¶å’Œåº“ï¼Œä¹Ÿä¸ä½¿ç”¨ç¼–è¯‘å™¨å’Œå¼•ç”¨ã€‚

## æŒ‘æˆ˜ä»»åŠ¡
æœ¬æ¬¡çš„æŒ‘æˆ˜ä»»åŠ¡ï¼Œæ˜¯åˆ©ç”¨æµè§ˆå™¨å†…ç½®`Web speech API`,å°†è‡ªå·±æ‰€è¯´çš„è¯è¾“å‡ºåœ¨é¡µé¢ä¸Š,ä»…chromeæµè§ˆå™¨æ”¯æŒã€‚  
**è¯´æ˜ï¼š**ç”±äºåªæœ‰chromeæµè§ˆå™¨å®ç°äº†è¯¥æ¥å£ï¼Œè€Œè¯­éŸ³è¯†åˆ«éœ€è¦å°†æ•æ‰åˆ°çš„ä¿¡æ¯å‘é€è‡³googleæœåŠ¡å™¨è¿›è¡Œå¤„ç†ï¼Œå› æ­¤ç”¨chromeæ‰èƒ½çœ‹åˆ°æ•ˆæœ

## ç›¸å…³çŸ¥è¯†
æœ‰å…³è¯­éŸ³è¯†åˆ«æ¥å£`SpeechRecognition`çš„è¯´æ˜ï¼Œå¯æŸ¥çœ‹[MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/SpeechRecognition)ä¸­çš„ç›¸å…³è§£é‡Šã€‚

## åŸºæœ¬æ€è·¯   
1.æ–°å»ºè¯­éŸ³è¯†åˆ«å¯¹è±¡;   
2.å¼€å¯è¯­éŸ³è¯†åˆ«æœåŠ¡;   
3.é€šè¿‡ç›‘å¬`result`äº‹ä»¶ï¼Œå®æ—¶è·å–æ•è·åˆ°çš„è¯­éŸ³ä¿¡æ¯;   
4.é€šè¿‡ç›‘å¬`end`äº‹ä»¶ï¼Œå½“ä¸€æ¬¡è¯­éŸ³æ•è·ç»“æŸåï¼Œé‡æ–°å¼€å¯è¯¥åŠŸèƒ½ï¼Œå®ç°æŒç»­çš„è¯­éŸ³ç›‘å¬åŠŸèƒ½ã€‚   

## è¿‡ç¨‹æŒ‡å—
1.ç”±äºç›®å‰åªæœ‰chromeæµè§ˆå™¨å®ç°äº†æ­¤åŠŸèƒ½ï¼Œæ•…ç›´æ¥ä½¿ç”¨å¸¦æœ‰å‰ç¼€çš„æ„é€ å‡½æ•°æ¥æ„å»ºä¸€ä¸ªè¯­éŸ³è¯†åˆ«å¯¹è±¡ã€‚   
```js
  const recognition = new SpeechRecognition();
```
2.è®¾ç½®è¯­éŸ³è¯†åˆ«å¯¹è±¡çš„åŸºæœ¬å±æ€§ï¼Œå¹¶å¼€å¯è¯¥åŠŸèƒ½ã€‚
```js
speech.interimResults = true;
//è¿”å›å³æ—¶è¯­éŸ³ï¼Œå³æ—¶è¯­éŸ³æ˜¯æŒ‡SpeechRecognitionResult.isFinal ä¸ºfalseæ—¶æ•è·åˆ°çš„ä¿¡æ¯ã€‚
speech.lang = 'zh-CN';//è®¾ç½®è¯­éŸ³è¯†åˆ«ç±»åˆ«ä¸ºè‹±è¯­

	//ç›‘å¬äº‹ä»¶
  speech.addEventListener('result', (e) => {
      const results = Array.from(e.results) 
      // e.resultsä¸­ä¿å­˜çš„æ˜¯è¯†åˆ«çš„ç»“æœï¼Œæœ¬æ¥å¹¶ä¸æ˜¯æ•°ç»„ï¼Œéœ€è¦å°†å…¶è½¬æ¢ä¸ºæ•°ç»„ï¼Œæ–¹ä¾¿ä½¿ç”¨å…¶mapã€joinç­‰æ–¹æ³•ã€‚
        .map(result => result[0])
        .map(result => result.transcript) // è·å–åˆ°æ¯ä¸€æ®µè¯ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹
        .join(''); // å°†æ¯ä¸€æ®µè¯è¿æ¥æˆå­—ç¬¦ä¸²
      
      //è½¬æ¢æŒ‡å®šçš„è¯
      const xcScript = transcript.replace(/æ—¥æœ¬å¤©çš‡|æ–°æ´¥æš´å¾’|é˜´é—´å¸¦å¸ˆ/gi, 'å­™ğŸ¶');
      p.textContent = xcScript;
       //å°†ç»“æœè¾“å‡ºåœ¨é¡µé¢ä¸Š
      if (e.results[0].isFinal) {
      	p = document.createElement('p');
      	words.appendChild(p);
    		}
      }

recognition.addEventListener('end', recognition.start);
recognition.start();//å¼€å¯åŠŸèƒ½
```
3.ç›‘å¬æ”¶åˆ°ç»“æœäº‹ä»¶ï¼Œå°†è¯­éŸ³è¯†åˆ«ç»“æœè¾“å‡ºåœ¨DOMå…ƒç´ ä¸Šã€‚   
```js
  speech.addEventListener('result', (e) => {
      const results = Array.from(e.results) 
      // e.resultsä¸­ä¿å­˜çš„æ˜¯è¯†åˆ«çš„ç»“æœï¼Œæœ¬æ¥å¹¶ä¸æ˜¯æ•°ç»„ï¼Œéœ€è¦å°†å…¶è½¬æ¢ä¸ºæ•°ç»„ï¼Œæ–¹ä¾¿ä½¿ç”¨å…¶mapã€joinç­‰æ–¹æ³•ã€‚
        .map(result => result[0])
        .map(result => result.transcript) // è·å–åˆ°æ¯ä¸€æ®µè¯ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹
        .join(''); // å°†æ¯ä¸€æ®µè¯è¿æ¥æˆå­—ç¬¦ä¸²
      
      //è½¬æ¢æŒ‡å®šçš„è¯
      const xcScript = transcript.replace(/æ—¥æœ¬å¤©çš‡|æ–°æ´¥æš´å¾’|é˜´é—´å¸¦å¸ˆ/gi, 'å­™ğŸ¶');
      p.textContent = xcScript;
       //å°†ç»“æœè¾“å‡ºåœ¨é¡µé¢ä¸Š
      if (e.results[0].isFinal) {
      	p = document.createElement('p');
      	words.appendChild(p);
    		}
      }
```

ç”±äºå›½å†…ç½‘ç»œåŸå› ï¼Œå¯è€ƒè™‘ä½¿ç”¨[ç§‘å¤§è®¯é£çš„è¯­éŸ³è¯†åˆ«sdk](http://www.xfyun.cn/)ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯è‡ªè¡Œå°è¯•å®ç°ã€‚
